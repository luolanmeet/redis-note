### 整数集合

整数集合(`intset`)是集合键的底层实现之一，当一个集合只包含整数值元素，

并且这个集合的元素数量不多时，`Redis`就会使用整数集合作为集合键的底层实现。

```c
> SADD numbers 1 3 5 7 9
(integer) 5
> OBJECT ENCODING numbers
"intset"
```



#### 整数集合的实现

整数集合(`intset`)是`Redis`用于保存整数值的集合抽象数据结构，可以保存类型为

`int16_t`、`int32_t`或者`int64_t`的整数值，并且保证集合中不会出现重复元素。

每个`intset.h/intset`结构表示一个整数集合

```c
typedef struct intset {
    // 编码方式
    uint32_t encoding;
    // 集合包含的元素数量
    uint32_t length;
    // 保存元素的数组
    int8_t contents[];
} intset;
```

`contents`数组是整数集合的底层实现：整数集合的每个元素都是`contents`数组的一个数组项(`item`)，

各个项在数组中按值的大小从小到大有序地排列，并且数组中不包含任何重复项。

`length`属性记录了整数集合包含的元素数量，也即是`contents`数组的长度。

虽然`intset`结构将`contents`属性声明为`int8_t`类型的数组，但实际上`contents`数组并不保存

任何`int8_t`类型的值，真正类型取决于`encoding`属性的值。



#### 升级

每当我们要将一个新元素添加到整数集合里边，并且新元素的类型比整数集合现有所有元素的类型

都要长时，整数集合需要先进行升级(`upgrade`)，然后才能将新元素添加到整数集合里面。

升级的过程：

* 根据新元素类型，扩展整数集合底层数组的空间大小，为新元素分配空间
* 将底层数组现有的所有元素都转换成与新元素相同的类型，将转换后的元素放置到正确位置上。
* 将新元素添加到底层数组里面。

升级的好处：

* 提升灵活性，可以自动升级底层数组来适应新元素，所以可以随意将`int16_t`、`int32_t`、`int64_t`添加到集合中。
* 节约内存，并不是直接使用最大的数据类型，而是根据实际情况去选择存储类型。

#### 降级

不支持降级