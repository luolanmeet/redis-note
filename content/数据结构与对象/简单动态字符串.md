### 简单动态字符串

#### 简概

`Redis`没有直接使用C语言传统的字符串表示（以空字符结尾的字符数组），

而是自己构建了一种名为简单动态字符串（`simple dynamic string，SDS`）的抽象类型，

并将`SDS`用作`Redis`的默认字符串表示。

示例：

```redis
SET msg "hello world"
```

`Redis`将在数据库中创建一个新的键值对，其中

* 键值对的键是一个字符串对象，底层实现是一个保存着字符串`msg`的`SDS`。
* 键值对的值是一个字符串对象，底层实现是一个保存着字符串`hello world`的`SDS`。

除了用来保存数据库中的字符串值之外，`SDS`还被用作缓冲区（`buffer`）、

`AOF`模块中的`AOF`缓冲区、客户端状态中的输入缓冲区。



#### `SDS`的定义

每个`sds.h/sdshdr`的结构表示一个`SDS`值：

```c
struct sdshdr {
    // 记录buf数组中已使用字节的数量
    // 等于SDS所保存的字符串的长度
    int len;
    // 记录buf数组中未使用字节的数量
    int free;   
    // 字节数组，用于保存字符串
    char buf[];
}
```

`SDS`遵循`C`字符串以空字符串结尾的惯例，保存空字符串的1字节空间不计算在`SDS`的

`len`属性里边，并且为空字符分配额外的1字节空间。

遵循空字符结尾的好处是，`SDS`可以直接重用一部分`C`字符串函数库的函数。



#### SDS与C字符串的区别

`C`语言使用的这种简单的字符串表示方式，并不能满足`Redis`对字符串在安全性、效率

以及功能方面的要求。

##### SDS解决的问题

* 常数复杂度获取字符串长度

  `C`字符串不记录自身的长度信息，所以获取一个`C`字符串的长度，

  需要遍历整个字符串，时间复杂度为`O(N)`。而`SDS`不需要，时间复杂度为`O(1)`。

* 杜绝缓冲区溢出

  `C`字符串不记录自身长度带来的另一个问题是容易造成缓冲区溢出(`buffer overflow`)

  `SDS` `API`需要对`SDS`进行修改时，`API`会先检查`SDS`的空间是否满足所需的要求，

  不满足的话会自动将`SDS`的空间扩展至执行修改所需的大小，然后才执行实际的修改。

* 减少修改字符串时带来的内存重分配次数

  每次增长或缩短一个`C`字符串，程序都总要对保存这个字符串的数组进行一次内存重新分配

  内存分配涉及复杂的算法，并且可能需要执行系统调用，所以通常是一个比较耗时的操作。

  `SDS`通过未使用空间解除了字符串长度和底层数组长度之间的关联。通过未使用空间，

  <span style="border-bottom:2px dashed yellow;">`SDS`实现了空间预分配和惰性空间释放两种优化策略。</span>

  > * 空间预分配：用于优化SDS的字符串增长操作，当SDS的API对一个SDS进行修改，
  >
  >   并且需要对SDS进行空间扩展的时候，程序不仅会为SDS分配修改所必须要的空间，
  >
  >   还会分配额外的未使用空间。
  >
  > * 惰性空间释放：用于优化SDS字符串缩短操作，当SDS的API需要缩短SDS保存的
  >
  >   字符串时，程序并不笔记使用内存重分配来回收缩短后多出的字节，而是使用free
  >
  >   属性将这些字节的数量记录起来，等待将来使用。

* 二进制安全

  `C`字符串中的字符必须符合某种编码，并且除了字符串的末尾之外，字符串里边不能包含

  空字符，否则最先被程序读入的空字符将被误认为是字符串结尾，这些限制使得`C`字符串

  只能保存文本，而不能保存像图片、音频、视频、压缩文件这样的二进制数据。

  为了确保`Redis`可以适用于各种不同的使用场景，`SDS`的`API`都是二进制安全的。

  都会以处理二进制的方式来处理`SDS`存放在`buf`数组里的数据。数据写入时什么样，

  读取时就是什么样。

* 兼容部分`C`字符串函数

| C字符串                                    | SDS                                        |
| ------------------------------------------ | ------------------------------------------ |
| 获取字符串长度的复杂度为O(N)               | 获取字符串长度的复杂度为O(1)               |
| API是不安全的，可能会造成缓冲区溢出        | API是安全 ，不会造成缓冲区溢出             |
| 修改字符串长度N次必然需要执行N次内存重分配 | 修改字符串长度N次最多需要执行N次内存重分配 |
| 只能保存文本数据                           | 可以保存文本或者二进制数据                 |
| 可以使用所有<string.h>库中的函数           | 可以使用部分<string.h>库中的函数           |



#### SDS API

| 函数        | 作用                                                         | 时间复杂度                                         |
| ----------- | ------------------------------------------------------------ | -------------------------------------------------- |
| sdsnew      | 创建一个包含给定c字符串的`SDS`                               | O(N)，N为给定c字符串的长度                         |
| sdsempty    | 创建一个不包含任何内容的`SDS`                                | O(1)                                               |
| sdsfree     | 释放给定的`SDS`                                              | O(N)，N为被释放的`SDS`的长度                       |
| sdslen      | 返回`SDS`的已使用的空间字节数                                | O(1)，读取`len`属性即可                            |
| sdsavail    | 返回`SDS`的未使用的空间字节数                                | O(1)，读取`free`属性即可                           |
| sdsdup      | 创建一个给定的`SDS`的副本                                    | O(N)，N为给定的`SDS`的长度                         |
| sdsclear    | 清空`SDS`保存的字符串内容                                    | 因为惰性空间释放策略，复杂度为O(1)                 |
| sdscat      | 将给定c字符串拼接到`SDS`字符串的尾部                         | O(N)，N为被拼接c字符串的长度                       |
| sdscatsds   | 将给定`SDS`拼接到l另一个`SDS`字符串的尾部                    | O(N)，N为被拼接`SDS`字符串的长度                   |
| sdscopy     | 将给定的c字符串复制到`SDS`里边，覆盖原字符串                 | O(N)，N为被复制c字符串的长度                       |
| sdsgrowzero | 用空字符串将`SDS`扩展至给定长度                              | O(N)，N为扩展新增的字节数                          |
| sdsrange    | 保留`SDS`给定区间内的数据，不在区间内数据会被覆盖或清除      | O(N)，N为被保留数据的字节数                        |
| sdstrim     | 接受一个`SDS`和一个c字符串作为参数，从`SDS`左右两端分别<br />移除所有在c字符串中出现过的字符 | O(M*N)，M为`SDS`的长度<br />N为给定的c字符串的长度 |
| sdscmp      | 对比两个`SDS`字符串是否相同                                  | O(N)，N为被两个`SDS`中较短的那个的长度             |



