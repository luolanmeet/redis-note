### 字符串对象

字符串对象的编码可以是`int`、`raw`或者`embstr`。



#### int

如果一个字符串对象保存的是整数值，并且这个整数值可以用`long`类型来表示，

那么字符串对象将整数值保存在字符串对象结构的`ptr`属性里边(将`void*`转换为`long`),

并将字符串对象的编码设置为`int`。

```c
> SET number 10086
OK
> OBJECT ENCODING number
"int"
```



#### raw

如果字符串对象保存的是一个字符串值，并且这个字符串值的长度大于39字节，那么字符串对象

将使用一个简单动态字符串(`SDS`)来保存这个字符串值，并将对象的编码设置为`raw`。

> 39字节，不同版本不一样

```c
> SET story "long, long, long ago, there lived a king ......."
OK
> STRLEN story
48
> OBJECT ENCODING story
raw
```

 

#### embstr

如果字符串对象保存的是一个字符串值，并且这个字符串值的长度小于等于39字节，

那么字符串对象将使用`embstr`编码的方式来保存这个字符串值。

`embstr`编码是专门用于保存短字符串的一种优化编码方式，这种编码和`raw`编码一样，

都使用`redisObject`结构和`sdshdr`结构来表示字符串对象，但`raw`编码会调用两次内存

分配函数来分别创建`redisObject`结构和`sdshdr`结构，而`embstr`编码则通过调用一次

内存分配函数来分配一块连续的空间，空间中依次包含`redisObject`和`sdshdr`两个结构。

使用`embstr`的好处：

* `embstr`编码将创建字符串对象所需的内存分配次数从两次降低为一次
* 释放`embstr`编码的字符串对象只需要调用一次内存释放函数
* 因为`embstr`编码的字符串对象所有数据都保存在一块连续的内存，所以能更好地利用缓存



#### 另外的

浮点数在`Redis`中也是作为字符串保存的，会先转为字符串值，在保存起来。

做运算时，会先转为浮点型，再做运算

```c
> SET pi 3.14
OK
> OBJECT ENCODING pi
"embstr"
> INCRBYFLOAT pi 2.0
"5.14"
> OBJECT ENCODING pi
"embstr"
```

字符串对象保存各类型值的编码方式：

| 值                                                           | 编码            |
| ------------------------------------------------------------ | --------------- |
| 可以用`long`类型保存的整数                                   | `int`           |
| 可以用`long double`类型保存的浮点数                          | `embstr`或`raw` |
| 字符串值<br />因为长度太大而无法用`long`类型表示的整数<br />因为长度太大而无法用`long double`类型表示的浮点数 | `embstr`或`raw` |



#### 编码的转换

`int`编码的字符串和`embstr`编码的字符串对象在条件满足的情况下，会被转换为`raw`编码的字符串对象。

```c
// int对象，不再是整数值时，将转换为raw，注意！不会转换为embstr
> SET number 10086
OK
> OBJECT ENCODING number
"int"
> APPEND number " is a number"
(integer) 17
> GET number
"10086 is a number"
> OBJECT ENCODING number
"raw"
    
// redis没有为embstr编码的字符串提供任何修改的函数，因此对embstr编码的
// 字符串对象进行任何修改时，embstr编码的字符串都会转为raw编码的字符串
> SET msg "hello world"
OK
> OBJECT ENCODING msg
"embstr"
> APPEND msg " again"
(integer) 17
> OBJECT ENCODING msg
"raw"
```



#### 字符串命令

| 命令          | int编码的实现方式                                            | embstr编码的实现方式                                         | raw编码的实现方式                                            |
| ------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `SET`         | 使用`int`编码保存值                                          | 使用`embstr`编码保存值                                       | 使用`raw`编码保存值                                          |
| `GET`         | 拷贝对象所保存的整数值，将这个拷贝转换成字符串值，然后向客户端返回这个字符串值 | 直接向客户端返回字符串值                                     | 直接向客户端返回字符串值                                     |
| `APPEND`      | 将对象转换为`raw`编码，然后按`raw`编码的方式执行此操作       | 将对象转换为`raw`编码，然后按`raw`编码的方式执行此操作       | 调用`sdscatlen`函数，将给定字符串追加到现有字符串的末尾      |
| `INCRBYFLOAT` | 取出整数值并将其转换称`long double`类型的浮点数，对这个浮点数进行加法计算，然后保存结果 | 取出字符串并尝试转为`long double`类型，对这个浮点数进行加法计算，然后保存结果。如果转换失败则向客户端返回一个错误 | 取出字符串并尝试转为`long double`类型，对这个浮点数进行加法计算，然后保存结果。如果转换失败则向客户端返回一个错误 |
| `INCRBY`      | 对整数值进行加法计算，得到的结果会作为整数被保存起来         | `embstr`编码不能执行此命令，向客户端返回一个错误             | `raw`编码不能执行此命令，向客户端返回一个错误                |
| `DECRBY`      | 对整数值进行减法计算，得到的结果会作为整数被保存起来         | `embstr`编码不能执行此命令，向客户端返回一个错误             | `raw`编码不能执行此命令，向客户端返回一个错误                |
| `STRLEN`      | 拷贝对象所保存的整数值，将这个拷贝转换成字符串值，计算并返回这个字符串值的长度 | 调用`sdslen`函数，返回字符串长度                             | 调用`sdslen`函数，返回字符串长度                             |
| `SETRANGE`    | 将对象转换成`raw`编码，然后按`raw`编码执行此命令             | 将对象转换成`raw`编码，然后按`raw`编码执行此命令             | 将字符串特定索引上的值设置为给定的字符                       |
| `GETRANGE`    | 拷贝对象所保存的整数值，将这个拷贝转换成字符串值，然后取出并返回字符串指定索引上的字符 | 直接取出并返回字符串指定索引上的字符                         | 直接取出并返回字符串指定索引上的字符                         |

